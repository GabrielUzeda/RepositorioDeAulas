<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folha de Ponto - Professor</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Material Icons for iconography -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Custom styles for a cleaner UI and print layout */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hide non-printable elements and reset background for printing */
        @media print {
            .no-print {
                display: none !important;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: white !important;
                -webkit-print-color-adjust: exact;
                /* Ensures background colors are printed in Chrome */
                color-adjust: exact;
                /* Standard property for printing background colors */
            }

            /* NEW: Reset layout for printing */
            .container {
                padding: 0 !important;
                margin: 0 !important;
                max-width: none !important;
                width: 100% !important;
                display: block !important;
            }

            .print-container {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                width: 100% !important;
                max-width: none !important;
                /* This ensures it shows up for printing even if it has a 'hidden' class */
                display: block !important;
            }
        }


        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Style for the custom alert/toast notification */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.5s ease-in-out;
            z-index: 1000;
        }

        #toast.show {
            bottom: 30px;
        }

        .date-range-container,
        #absenceNameContainer {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
    </style>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 lg:p-8 flex flex-col items-center">

        <!-- Header Section -->
        <header class="bg-white rounded-lg shadow-lg p-6 no-print w-full max-w-5xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="material-icons mr-3 text-blue-600 text-4xl">schedule</span>
                Gerador de Folha de Ponto
            </h1>

            <!-- Main Data Form as Table -->
            <table class="w-full table-fixed border-collapse">
                <tbody>
                    <!-- Linha 1: Nome do Professor + Função -->
                    <tr>
                        <td class="p-3" colspan="2">
                            <label for="professorName" class="block text-sm font-medium text-gray-700 mb-2">
                                Nome do Professor
                            </label>
                            <input type="text" id="professorName"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                                placeholder="Digite o nome do professor">
                        </td>
                        <td class="p-3" colspan="2">
                            <label for="function" class="block text-sm font-medium text-gray-700 mb-2">
                                Função
                            </label>
                            <input type="text" id="function" class="w-full p-3 border border-gray-300 rounded-lg"
                                value="Professor para Educação Profissional e Tecnológica X">
                        </td>
                    </tr>

                    <!-- Linha 2: Escola -->
                    <tr>
                        <td class="p-3" colspan="4">
                            <label for="schoolName" class="block text-sm font-medium text-gray-700 mb-2">
                                Escola
                            </label>
                            <select id="schoolName"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                                <option value="EFG SARAH LUISA LEMOS KUBITSCHEK DE OLIVEIRA">
                                    EFG SARAH LUISA LEMOS KUBITSCHEK DE OLIVEIRA - SANTO ANTÔNIO DO DESCOBERTO
                                </option>
                                <option value="ESCOLA DO FUTURO JOSÉ LUIZ BITTENCOURT" selected>
                                    EFG JOSE LUIZ BITTENCOURT – GOIÂNIA
                                </option>
                                <option value="EFG JL BITTENC - UDEPI MOSSAMEDES">
                                    EFG JL BITTENC - UDEPI MOSSAMEDES
                                </option>
                                <option value="EFG LUIZ RASSI - NART">
                                    EFG LUIZ RASSI - NART - CIDADE DE GOIÁS
                                </option>
                                <option value="EFG RAUL BRANDAO DE CASTRO">
                                    EFG RAUL BRANDAO DE CASTRO – MINEIROS
                                </option>
                                <option value="EFG LUIZ RASSI - APARECIDA">
                                    EFG LUIZ RASSI - APARECIDA DE GOIÂNIA
                                </option>
                                <option value="EFG EM ARTES BASILEU FRANCA">
                                    EFG EM ARTES BASILEU FRANCA – GOIÂNIA
                                </option>
                                <option value="EFG LUIZ RASSI - PROJETO JORNADA">
                                    EFG LUIZ RASSI - PROJETO JORNADA PARA O FUTURO – GOIÂNIA
                                </option>
                                <option value="EFG LUIZ RASSI - REDE DE ORQUESTRAS">
                                    EFG LUIZ RASSI- REDE DE ORQUESTRAS - APARECIDA DE GOIÂNIA
                                </option>
                            </select>
                        </td>
                    </tr>

                    <!-- Linha 3: Contrato + Chapa + Data + Mês/Ano -->
                    <tr>
                        <td class="p-3">
                            <label for="contractType" class="block text-sm font-medium text-gray-700 mb-2">
                                Contrato
                            </label>
                            <select id="contractType" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="CLT" selected>CLT</option>
                                <option value="RPA">RPA</option>
                            </select>
                        </td>
                        <td class="p-3">
                            <label for="chapa" class="block text-sm font-medium text-gray-700 mb-2">
                                Chapa
                            </label>
                            <input type="text" id="chapa" class="w-full p-3 border border-gray-300 rounded-lg"
                                value="009268">
                        </td>
                        <td class="p-3">
                            <label for="admissionDate" class="block text-sm font-medium text-gray-700 mb-2">
                                Data de Admissão
                            </label>
                            <input type="date" id="admissionDate" class="w-full p-3 border border-gray-300 rounded-lg"
                                value="2025-08-25">
                        </td>
                        <td class="p-3">
                            <label for="monthYear" class="block text-sm font-medium text-gray-700 mb-2">
                                Mês/Ano
                            </label>
                            <input type="month" id="monthYear"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </td>
                    </tr>
                </tbody>
            </table>
        </header>


        <!-- Module Registration Section -->
        <section class="bg-white rounded-lg shadow-lg p-6 my-6 no-print w-full max-w-5xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="material-icons mr-2 text-green-600">class</span>
                Cadastro de Módulos
            </h2>

            <form id="moduleForm" class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="moduleName" class="block text-sm font-medium text-gray-700 mb-2">Nome do
                            Módulo</label>
                        <input type="text" id="moduleName" class="w-full p-2 border border-gray-300 rounded-lg"
                            placeholder="Ex: Matemática I" required>
                    </div>
                    <div>
                        <label for="moduleType"
                            class="block text-sm font-medium text-gray-700 mb-2">Modalidade</label>
                        <select id="moduleType" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="presencial">Presencial</option>
                            <option value="online">Online</option>
                            <option value="ead">EAD/P</option>
                        </select>
                    </div>
                </div>

                <!-- Module Period Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Período de Validade do
                        Módulo</label>
                    <div class="flex items-center space-x-4 p-2 bg-white rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="modulePeriodType" value="full" checked
                                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Mês Inteiro</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="modulePeriodType" value="partial"
                                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Período Parcial</span>
                        </label>
                    </div>
                </div>
                <div id="modulePartialPeriodContainer" class="date-range-container grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="moduleStartDate" class="block text-sm font-medium text-gray-700 mb-2">Data de
                            Início
                            do
                            Módulo</label>
                        <input type="date" id="moduleStartDate"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    </div>
                    <div>
                        <label for="moduleEndDate" class="block text-sm font-medium text-gray-700 mb-2">Data de Fim
                            do
                            Módulo</label>
                        <input type="date" id="moduleEndDate"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dias da Semana</label>
                    <div id="daysOfWeekContainer" class="flex flex-wrap gap-2">
                        <!-- Checkboxes will be injected by JS -->
                    </div>
                </div>

                <div id="daySchedules" class="space-y-3 mb-4">
                    <!-- Dynamic time slot inputs will appear here -->
                </div>

                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-transform transform hover:scale-105">
                    <span class="material-icons mr-2">add</span>
                    Adicionar Módulo
                </button>
            </form>

            <div>
                <h3 class="text-lg font-medium text-gray-800 mb-3">Módulos Cadastrados</h3>
                <div id="modulesList" class="space-y-2">
                    <p class="text-gray-500 italic">Nenhum módulo cadastrado ainda.</p>
                </div>
            </div>
        </section>

        <!-- Absence Registration Section -->
        <section class="bg-white rounded-lg shadow-lg p-6 mb-6 no-print w-full max-w-5xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="material-icons mr-2 text-red-600">event_busy</span>
                Cadastro de Ausências
            </h2>
            <div class="mb-4">
                <h3 class="text-lg font-medium text-gray-800 mb-3">Ausências Cadastradas</h3>
                <div id="absencesList" class="space-y-2">
                    <p class="text-gray-500 italic">Nenhuma ausência cadastrada.</p>
                </div>
            </div>
            <form id="absenceForm" class="bg-gray-50 p-4 rounded-lg">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Ausência</label>
                    <div class="flex items-center space-x-4 p-2 bg-white rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="absenceType" value="feriado" checked
                                class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Feriado</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="absenceType" value="atestado"
                                class="h-4 w-4 text-yellow-500 border-gray-300 focus:ring-yellow-500">
                            <span class="ml-2 text-sm text-gray-700">Atestado</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="absenceType" value="falta"
                                class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                            <span class="ml-2 text-sm text-gray-700">Falta</span>
                        </label>

                    </div>
                </div>

                <div id="absenceNameContainer" class="mb-4">
                    <label for="absenceName" class="block text-sm font-medium text-gray-700 mb-2">Nome do
                        Feriado</label>
                    <input type="text" id="absenceName" class="w-full p-2 border border-gray-300 rounded-lg"
                        placeholder="Ex: Dia do Trabalho">
                </div>

                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="absenceStartDate" class="block text-sm font-medium text-gray-700 mb-2">Data de
                            Início</label>
                        <input type="date" id="absenceStartDate"
                            class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="absenceEndDate" class="block text-sm font-medium text-gray-700 mb-2">Data de
                            Fim</label>
                        <input type="date" id="absenceEndDate" class="w-full p-2 border border-gray-300 rounded-lg"
                            required>
                    </div>
                    <div>
                        <label for="absenceStartTime" class="block text-sm font-medium text-gray-700 mb-2">Horário
                            de
                            Início
                            (Opcional)</label>
                        <select id="absenceStartTime" data-role="start-time"
                            class="time-select border border-gray-300 rounded px-2 py-1 text-sm w-full cursor-pointer"></select>
                    </div>
                    <div>
                        <label for="absenceEndTime" class="block text-sm font-medium text-gray-700 mb-2">Horário de
                            Fim
                            (Opcional)</label>
                        <select id="absenceEndTime" data-role="end-time"
                            class="time-select border border-gray-300 rounded px-2 py-1 text-sm w-full cursor-pointer"></select>
                    </div>
                </div>
                <button type="submit"
                    class="text-white px-4 py-2 rounded-lg flex items-center transition-transform transform hover:scale-105">
                    <span class="material-icons mr-2">add</span>
                    Adicionar Ausência
                </button>
            </form>
        </section>


        <!-- Schedule Grid Visualization -->
        <section class="bg-white rounded-lg shadow-lg p-6 mb-6 no-print w-full max-w-5xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="material-icons mr-2 text-blue-600">calendar_view_week</span>
                Grade de Horários
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full border border-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="border border-gray-300 p-2 text-sm font-medium w-24">Horário</th>
                            <th class="border border-gray-300 p-2 text-sm font-medium">Segunda</th>
                            <th class="border border-gray-300 p-2 text-sm font-medium">Terça</th>
                            <th class="border border-gray-300 p-2 text-sm font-medium">Quarta</th>
                            <th class="border border-gray-300 p-2 text-sm font-medium">Quinta</th>
                            <th class="border border-gray-300 p-2 text-sm font-medium">Sexta</th>
                            <th class="border border-gray-300 p-2 text-sm font-medium">Sábado</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleGrid">
                        <!-- Grid will be generated dynamically -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Generated Timesheet (for printing) -->
        <section id="timesheetContainer" class="bg-white rounded-lg shadow-lg print-container hidden w-full max-w-5xl">
            <div class="p-6">
                <header class="table-auto">
                    <h1 class="text-xs text-center font-bold ">FOLHA DE PONTO - MÊS <span
                            id="displayMonth"></span>
                        - <span id="displayYear"></span></h1>
                </header>
                <div class="overflow-x-auto ">
                    <table class="w-full border-collapse border border-gray-400 text-[0.5rem]">
                        <thead>
                            <tr class=" text-[0.65rem]">
                                <!-- ESCOLA -->
                                <td class="pr-4 border border-gray-400" rowspan="2" colspan="7">
                                    <div class="mb-2">
                                        <strong>ESCOLA:</strong> <span id="displaySchool"
                                            class="font-normal"></span>
                                    </div>
                                </td>
                                <!-- CHAPA -->
                                <td class="text-left border border-gray-400" colspan="5">
                                    <div><strong>CHAPA:</strong> <span id="displayChapa" class="font-normal"></span>
                                    </div>
                                </td>
                            </tr>

                            <!-- Row 2 -->
                            <tr class=" text-[0.65rem]">
                                <!-- LOTADO NA EFG -->
                                <td class="text-left border border-gray-400" colspan="5">
                                    <div><strong>LOTADO NA EFG:</strong> <span id="displayLotacao"
                                            class="font-normal">BITTENCOURT</span></div>
                                </td>
                            </tr>

                            <!-- Row 3 -->
                            <tr class=" text-[0.65rem]">
                                <!-- NOME PROFESSOR -->
                                <td class="pr-4 border border-gray-400" rowspan="2" colspan="7">
                                    <div class="mb-2">
                                        <strong>NOME DO PROFESSOR(A):</strong> <span id="displayProfessor"
                                            class="font-normal"></span>
                                    </div>
                                </td>
                                <!-- CONTRATO -->
                                <td class="text-left border border-gray-400" colspan="5">
                                    <strong>CONTRATO:</strong>
                                    &nbsp;&nbsp; ( <span id="displayContratoCltPercent"> </span> ) CLT
                                    &nbsp;&nbsp; ( <span id="displayContratoRpaPercent"> </span> ) RPA
                                </td>
                            </tr>

                            <!-- Row 4 -->
                            <tr class=" text-[0.65rem]" <!-- DATA DA ADMISSÃO -->
                                <td class="text-left border border-gray-400" colspan="5">
                                    <div><strong>DATA DA ADMISSÃO:</strong> <span id="displayAdmissionDate"
                                            class="font-normal"></span></div>
                                </td>
                            </tr>

                            <!-- Row 5 FUNÇÃO -->
                            <tr class=" text-[0.65rem]">
                                <td class="border border-gray-400" colspan="7">
                                    <div><strong>FUNÇÃO:</strong> <span id="displayFunction"
                                            class="font-normal"></span>
                                    </div>
                                </td>
                                <td class="border border-gray-400" colspan="5">
                                    <div><strong>HORÁRIO DE TRABALHO DE SEGUNDA A SÁBADO:</strong><br>
                                        08:00 - 12:00 / 13:00 - 17:00 / 18:00 - 22:00
                                    </div>
                                </td>
                            </tr>
                            <tr class="bg-gray-100">
                                <th rowspan="2" class="border border-gray-400 p-1 ">DIA</th>
                                <th rowspan="2" class="border border-gray-400 p-1 ">ENTRADA MATUTINO</th>
                                <th rowspan="2" class="border border-gray-400 p-1 ">SAÍDA MATUTINO</th>
                                <th rowspan="2" class="border border-gray-400 p-1 ">ENTRADA VESPERTINO</th>
                                <th rowspan="2" class="border border-gray-400 p-1 ">SAÍDA VESPERTINO</th>
                                <th rowspan="2" class="border border-gray-400 p-1 ">ENTRADA NOTURNO</th>
                                <th rowspan="2" class="border border-gray-400 p-1 ">SAÍDA NOTURNO</th>
                                <th colspan="4" class="border border-gray-400 p-1">TIPO DE HORAS TRABALHADAS</th>
                                <th rowspan="2" class="border border-gray-400 p-1 w-48">ASSINATURA OU VISTO DO
                                    DOCENTE
                                </th>
                            </tr>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-400 w-16">PRESENCIAL</th>
                                <th class="border border-gray-400 w-16 "> ONLINE </th>
                                <th class="border border-gray-400 w-16 "> EAD / P </th>
                                <th class="border border-gray-400 w-16 "> ATESTADO </th>
                            </tr>
                        </thead>
                        <tbody id="timesheetBody">
                            <!-- Timesheet rows will be generated here -->
                        </tbody>
                        <tfoot class="bg-gray-50 text-[0.65rem] font-bold">
                            <tr>
                                <td colspan="11" class="border border-gray-400 p-1 text-right">
                                    TOTAL DE HORAS TRABALHADAS NO MÊS:
                                </td>
                                <td colspan="1" class="border border-gray-400 p-1 text-left">
                                    <span id="displayTotalHours" class="font-bold"></span>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="12" class="align-top p-2 text-left">
                                    <div><strong>OBSERVAÇÕES:</strong></div>
                                    <div class="border border-gray-300 min-h-[4rem]" id="displayObservations"></div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6" class="p-2">
                                    <div class="border-b-2 border-gray-600 pt-1">
                                        <strong>ASSINATURA DO PROFESSOR:</strong>
                                    </div>
                                </td>
                                <td colspan="6" class="p-2">
                                    <div class="border-b-2 border-gray-600 pt-1">
                                        <strong>ASSINATURA DO GESTOR:</strong>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>


        <!-- Action Buttons -->
        <footer class="no-print mt-6 w-full max-w-5xl">
            <table class="mx-auto">
                <tbody>
                    <tr>
                        <td class="p-2">
                            <button id="generateBtn"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center text-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                <span class="material-icons mr-2">assignment</span>
                                Gerar Folha de Ponto
                            </button>
                        </td>
                        <td class="p-2">
                            <button id="saveBtn"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center text-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                <span class="material-icons mr-2">save</span>
                                Salvar Dados
                            </button>
                        </td>
                        <td class="p-2">
                            <button id="loadBtn"
                                class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center text-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                <span class="material-icons mr-2">folder_open</span>
                                Carregar Dados
                            </button>
                        </td>
                        <td class="p-2">
                            <button id="printBtn"
                                class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg flex items-center text-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                <span class="material-icons mr-2">print</span>
                                Imprimir
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <input type="file" id="loadFile" class="hidden" accept=".json">
        </footer>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast" class="bg-gray-800 no-print"></div>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(function () {
            // --- STATE MANAGEMENT ---
            let modules = [];
            let absences = [];
            let currentModuleId = 0;
            let currentAbsenceId = 0;
            const DAY_CONFIG = {
                segunda: { name: 'Segunda', dateJsId: 1 },
                terca: { name: 'Terça', dateJsId: 2 },
                quarta: { name: 'Quarta', dateJsId: 3 },
                quinta: { name: 'Quinta', dateJsId: 4 },
                sexta: { name: 'Sexta', dateJsId: 5 },
                sabado: { name: 'Sábado', dateJsId: 6 },
            };

            // --- JQUERY OBJECT REFERENCES ---
            const $DOMElements = {
                monthYear: $('#monthYear'),
                moduleForm: $('#moduleForm'),
                absenceForm: $('#absenceForm'),
                modulesList: $('#modulesList'),
                absencesList: $('#absencesList'),
                scheduleGrid: $('#scheduleGrid'),
                timesheetContainer: $('#timesheetContainer'),
                timesheetBody: $('#timesheetBody'),
                toast: $('#toast'),
                daysOfWeekContainer: $('#daysOfWeekContainer'),
                daySchedules: $('#daySchedules'),
                modulePartialPeriodContainer: $('#modulePartialPeriodContainer'),
                absenceNameContainer: $('#absenceNameContainer'),
            };

            // --- UTILITY FUNCTIONS ---
            const showToast = (message, isError = false) => {
                $DOMElements.toast.text(message)
                    .removeClass('bg-red-600 bg-green-600')
                    .addClass(isError ? 'bg-red-600' : 'bg-green-600')
                    .addClass('show');
                setTimeout(() => {
                    $DOMElements.toast.removeClass('show');
                }, 3000);
            };

            const getMonthName = (month) => [
                'JANEIRO', 'FEVEREIRO', 'MARÇO', 'ABRIL', 'MAIO', 'JUNHO',
                'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'
            ][month - 1];

            const generateTimeOptions = (startHour, endHour, isOptional = false) => {
                let options = isOptional ? '<option value="">--:--</option>' : '';
                for (let h = startHour; h <= endHour; h++) {
                    const hour = String(h).padStart(2, '0');
                    options += `<option value="${hour}:00">${hour}:00</option>`;
                }
                return options;
            };

            /**
             * NEW: Randomizes a time string by adding/subtracting up to 3 minutes.
             * @param {string} timeStr - The time in HH:MM format.
             * @returns {string} The randomized time in HH:MM format.
             */
            const randomizeTime = (timeStr) => {
                if (!timeStr) return '';
                const [hours, minutes] = timeStr.split(':').map(Number);
                const randomMinutes = Math.floor(Math.random() * 7) - 3; // -3 to +3
                const date = new Date();
                date.setHours(hours, minutes + randomMinutes);
                const newHours = String(date.getHours()).padStart(2, '0');
                const newMinutes = String(date.getMinutes()).padStart(2, '0');
                return `${newHours}:${newMinutes}`;
            };

            /**
             * NEW: Calculates the duration in minutes between two time strings.
             * @param {string} startStr - The start time in HH:MM format.
             * @param {string} endStr - The end time in HH:MM format.
             * @returns {number} The duration in minutes.
             */
            const calculateDurationInMinutes = (startStr, endStr) => {
                if (!startStr || !endStr) return 0;
                const [startHours, startMinutes] = startStr.split(':').map(Number);
                const [endHours, endMinutes] = endStr.split(':').map(Number);
                const startTotalMinutes = startHours * 60 + startMinutes;
                const endTotalMinutes = endHours * 60 + endMinutes;
                return endTotalMinutes - startTotalMinutes;
            };

            const updateDateRangeConstraints = () => {
                const [year, month] = $DOMElements.monthYear.val().split('-');
                if (!year || !month) return;

                const firstDay = `${year}-${month}-01`;
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                const lastDay = `${year}-${month}-${String(lastDayOfMonth).padStart(2, '0')}`;

                const dateInputs = $('#moduleStartDate, #moduleEndDate, #absenceStartDate, #absenceEndDate');
                dateInputs.attr({ min: firstDay, max: lastDay });

                dateInputs.each(function () {
                    const $input = $(this);
                    if (!$input.val() || $input.val() < firstDay || $input.val() > lastDay) {
                        $input.val(firstDay);
                    }
                });
            };

            const fetchAndAddHolidays = () => {
                const [year, month] = $DOMElements.monthYear.val().split('-');
                if (!year || !month) return;

                absences = absences.filter(a => a.isManual); // Keep only manually added absences

                showToast('Buscando feriados do mês...', false);

                $.ajax({
                    url: `https://brasilapi.com.br/api/feriados/v1/${year}`,
                    method: 'GET',
                    timeout: 5000
                })
                    .done(function (data) {
                        const selectedMonth = parseInt(month, 10);

                        data.forEach(holiday => {
                            const holidayMonth = new Date(holiday.date + 'T12:00:00Z').getUTCMonth() + 1;

                            if (holidayMonth === selectedMonth) {
                                const alreadyExists = absences.some(a => a.startDate === holiday.date && !a.isManual);
                                if (!alreadyExists) {
                                    absences.push({
                                        id: currentAbsenceId++,
                                        type: 'feriado',
                                        name: holiday.name,
                                        startDate: holiday.date,
                                        endDate: holiday.date,
                                        isManual: false
                                    });
                                }
                            }
                        });
                        updateAbsencesList();
                        showToast('Feriados carregados!', false);
                    })
                    .fail(function () {
                        showToast('Não foi possível buscar feriados.', true);
                    });
            };


            // --- INITIALIZATION ---
            const initializeApp = () => {
                $('#monthYear').val(new Date().toISOString().slice(0, 7));
                $('#professorName').val('GABRIEL SOARES UZEDA');
                $DOMElements.modulePartialPeriodContainer.hide();
                $DOMElements.absenceNameContainer.hide();
                $('#absenceStartTime').html(generateTimeOptions(7, 21, true));
                $('#absenceEndTime').html(generateTimeOptions(8, 22, true));
                updateDateRangeConstraints();
                fetchAndAddHolidays();

                $.each(DAY_CONFIG, (dayKey, config) => {
                    $DOMElements.daysOfWeekContainer.append(`
                          <div class="relative">
                            <input type="checkbox" id="day-${dayKey}" value="${dayKey}" name="module-days" class="peer absolute h-full w-full opacity-0 cursor-pointer">
                            <label for="day-${dayKey}" class="block cursor-pointer select-none rounded-lg border-2 border-gray-300 p-2 text-center font-medium text-gray-600 transition-colors duration-200 ease-in-out hover:bg-gray-100 peer-checked:border-blue-500 peer-checked:bg-blue-500 peer-checked:text-white">${config.name}</label>
                          </div>`);

                    $DOMElements.daySchedules.append(`
                          <div id="schedule-${dayKey}" class="border border-gray-200 p-3 rounded-lg space-y-2 hidden" data-day="${dayKey}">
                              <div class="flex items-center justify-between mb-2">
                                  <h4 class="font-medium text-gray-800">${config.name}</h4>
                                  <button type="button" data-action="addTimeSlot" data-day="${dayKey}" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded flex items-center">
                                      <span class="material-icons text-sm mr-1">add</span> Horário
                                  </button>
                              </div>
                              <div id="timeSlots-${dayKey}"></div>
                          </div>`);
                });
                $('input[name="absenceType"]:checked').trigger('change');
            };

            // --- DOM MANIPULATION & RENDERING ---
            const addTimeSlotToContainer = (container) => {
                const $timeSlotDiv = $('<div>', { class: 'flex gap-2 items-center' }).html(`
                      <select data-role="start-time" class="time-select border border-gray-300 rounded px-2 py-1 text-sm w-28 cursor-pointer" required>
                          ${generateTimeOptions(7, 21)}
                      </select>
                      <span class="text-gray-500 text-sm">às</span>
                      <select data-role="end-time" class="time-select border border-gray-300 rounded px-2 py-1 text-sm w-28 cursor-pointer" required>
                          ${generateTimeOptions(8, 22)}
                      </select>
                      <button type="button" data-action="removeTimeSlot" class="text-red-500 hover:text-red-700 flex items-center justify-center w-8 h-8 rounded-full hover:bg-red-100">
                          <span class="material-icons text-base">delete_outline</span>
                      </button>`);
                $(container).append($timeSlotDiv);
                updateEndTimeOptions($timeSlotDiv.find('[data-role="start-time"]'));
            };

            const updateEndTimeOptions = ($startTimeSelect) => {
                const $endTimeSelect = $startTimeSelect.closest('.grid, .flex').find('[data-role="end-time"]');
                const startTimeValue = $startTimeSelect.val();
                let firstValidEndTime = null;

                if (!startTimeValue) { // If optional start time is cleared
                    $endTimeSelect.children('option').prop('disabled', false).prop('hidden', false);
                    return;
                }

                $endTimeSelect.children('option').each(function () {
                    const $option = $(this);
                    if ($option.val() === "") return;
                    const isInvalid = $option.val() <= startTimeValue;
                    $option.prop('disabled', isInvalid).prop('hidden', isInvalid);
                    if (!isInvalid && !firstValidEndTime) {
                        firstValidEndTime = $option.val();
                    }
                });

                if ($endTimeSelect.val() <= startTimeValue) {
                    $endTimeSelect.val(firstValidEndTime);
                }
            };

            const updateModulesList = () => {
                if (modules.length === 0) {
                    $DOMElements.modulesList.html('<p class="text-gray-500 italic">Nenhum módulo cadastrado ainda.</p>');
                    return;
                }
                const modulesHtml = modules.map(module => {
                    let periodText = 'Mês Inteiro';
                    if (module.periodType === 'partial') {
                        const start = new Date(module.startDate + 'T00:00:00').toLocaleDateString('pt-BR');
                        const end = new Date(module.endDate + 'T00:00:00').toLocaleDateString('pt-BR');
                        periodText = `${start} a ${end}`;
                    }
                    const scheduleText = Object.entries(module.schedule)
                        .map(([day, slots]) => `${DAY_CONFIG[day].name}: ${slots.map(s => `${s.start}-${s.end}`).join(', ')}`)
                        .join(' | ');

                    return `
                      <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-white shadow-sm">
                          <div>
                              <div class="font-medium">${module.name} <span class="text-xs font-normal text-gray-500">(${periodText})</span></div>
                              <div class="text-sm text-gray-500 capitalize mb-1">${module.type}</div>
                              <div class="text-xs text-gray-400">${scheduleText}</div>
                          </div>
                          <button data-action="removeModule" data-id="${module.id}" class="text-red-500 hover:text-red-700 flex items-center justify-center w-10 h-10 rounded-full hover:bg-red-100 transition">
                              <span class="material-icons">delete</span>
                          </button>
                      </div>`;
                }).join('');
                $DOMElements.modulesList.html(modulesHtml);
            };

            const updateAbsencesList = () => {
                const absenceColorMap = {
                    falta: { text: 'text-red-700', border: 'border-red-500' },
                    atestado: { text: 'text-yellow-700', border: 'border-yellow-500' },
                    feriado: { text: 'text-blue-700', border: 'border-blue-500' }
                };
                if (absences.length === 0) {
                    $DOMElements.absencesList.html('<p class="text-gray-500 italic">Nenhuma ausência cadastrada.</p>');
                    return;
                }
                const absencesHtml = absences.map(absence => {
                    const start = new Date(absence.startDate + 'T00:00:00').toLocaleDateString('pt-BR');
                    const end = absence.endDate !== absence.startDate ? ` a ${new Date(absence.endDate + 'T00:00:00').toLocaleDateString('pt-BR')}` : '';
                    let typeText = { falta: 'Falta', atestado: 'Atestado', feriado: 'Feriado' }[absence.type];
                    const colors = absenceColorMap[absence.type] || absenceColorMap.falta;

                    if (absence.type === 'feriado' && absence.name) {
                        typeText += `: ${start} - ${absence.name}`;
                    } else {
                        typeText += `: ${start}${end}`;
                    }

                    return `
                      <div class="flex items-center justify-between p-3 border-l-4 ${colors.border} rounded-lg bg-white shadow-sm">
                          <div>
                            <div class="font-medium ${colors.text} capitalize">${typeText}</div>
                          </div>
                          <button data-action="removeAbsence" data-id="${absence.id}" class="text-red-500 hover:text-red-700 flex items-center justify-center w-10 h-10 rounded-full hover:bg-red-100 transition">
                              <span class="material-icons">delete</span>
                          </button>
                      </div>`;
                }).join('');
                $DOMElements.absencesList.html(absencesHtml);
            };

            const updateScheduleGrid = () => {
                const allTimes = new Set();
                modules.forEach(m => Object.values(m.schedule).flat().forEach(s => {
                    allTimes.add(s.start);
                    allTimes.add(s.end);
                }));

                const sortedTimes = Array.from(allTimes).sort();
                if (sortedTimes.length === 0) {
                    $DOMElements.scheduleGrid.html(`<tr><td colspan="7" class="text-center p-4 text-gray-500">Adicione módulos para ver a grade de horários.</td></tr>`);
                    return;
                }

                const gridHtml = sortedTimes.map((time, index) => {
                    if (index === sortedTimes.length - 1) return '';
                    const nextTime = sortedTimes[index + 1];

                    const dayCells = Object.keys(DAY_CONFIG).map(dayKey => {
                        const moduleAtTime = modules.find(m =>
                            m.schedule[dayKey]?.some(slot => time >= slot.start && nextTime <= slot.end)
                        );
                        return moduleAtTime
                            ? `<td class="border border-gray-300 p-1 text-center text-xs font-medium text-blue-800 bg-blue-100">${moduleAtTime.name}</td>`
                            : `<td class="border border-gray-300 p-1"></td>`;
                    }).join('');

                    return `
                          <tr>
                              <td class="border border-gray-300 p-1 font-medium bg-gray-50 text-xs text-center">${time} - ${nextTime}</td>
                              ${dayCells}
                          </tr>`;
                }).join('');
                $DOMElements.scheduleGrid.html(gridHtml);
            };

            const clearModuleForm = () => {
                $DOMElements.moduleForm[0].reset();
                $('input[name="module-days"]').prop('checked', false).trigger('change');
                $DOMElements.modulePartialPeriodContainer.slideUp();
            };

            const generateTimesheet = () => {
                const [year, month] = $DOMElements.monthYear.val().split('-');
                if (!year || !month) {
                    showToast("Por favor, selecione o Mês/Ano.", true);
                    return;
                }

                // Populate header
                $('#displayMonth').text(getMonthName(parseInt(month)));
                $('#displayYear').text(year);
                $('#displayProfessor').text($('#professorName').val());
                $('#displaySchool').text($('#schoolName').val());
                $('#displayChapa').text($('#chapa').val());
                $('#displayFunction').text($('#function').val());

                const admissionDateVal = $('#admissionDate').val();
                if (admissionDateVal) {
                    $('#displayAdmissionDate').text(new Date(admissionDateVal + 'T00:00:00').toLocaleDateString('pt-BR'));
                }
                const contractType = $('#contractType').val();
                $('#displayContratoCltPercent').text(contractType === 'CLT' ? 'X' : ' ');
                $('#displayContratoRpaPercent').text(contractType === 'RPA' ? 'X' : ' ');


                let tableContent = '';
                const endDay = new Date(year, month, 0).getDate();
                let totalMinutesWorked = 0; // NEW: Initialize total worked minutes counter

                for (let day = 1; day <= endDay; day++) {
                    const currentDate = new Date(year, month - 1, day);
                    const currentDateStr = currentDate.toISOString().split('T')[0];
                    const dayOfWeek = currentDate.getDay();
                    const dayCell = `<td class="border border-gray-400 p-1 text-center font-medium text-xs">${String(day).padStart(2, '0')}/${month}</td>`;

                    const todaysAbsence = absences.find(a => currentDateStr >= a.startDate && currentDateStr <= a.endDate);

                    if (dayOfWeek === 0) {
                        tableContent += `<tr>${dayCell}<td colspan="11" class="border border-gray-400 p-1 text-center bg-gray-200 text-xs font-medium">DOMINGO</td></tr>`;
                    } else if (todaysAbsence && (todaysAbsence.type === 'falta' || todaysAbsence.type === 'feriado')) {
                        const justification = todaysAbsence.type === 'feriado' ? todaysAbsence.name.toUpperCase() : 'FALTA';
                        tableContent += `<tr>${dayCell}<td colspan="11" class="border border-gray-400 p-1 text-center bg-gray-100 text-xs font-medium">${justification}</td></tr>`;
                    } else if (todaysAbsence && todaysAbsence.type === 'atestado') {
                        // For simplicity, we assume atestado covers the whole day and don't add hours
                        const emptyCells = '<td class="border border-gray-400 p-1"></td>'.repeat(6);
                        tableContent += `<tr>${dayCell}${emptyCells}<td class="border border-gray-400 p-1"></td><td class="border border-gray-400 p-1"></td><td class="border border-gray-400 p-1"></td><td class="border border-gray-400 p-1 text-center font-bold">X</td><td class="border border-gray-400 p-1"></td></tr>`;

                    } else {
                        const dayKey = Object.keys(DAY_CONFIG).find(key => DAY_CONFIG[key].dateJsId === dayOfWeek);
                        const activeModulesToday = modules.filter(m =>
                            m.schedule[dayKey] && (m.periodType === 'full' || (currentDateStr >= m.startDate && currentDateStr <= m.endDate))
                        );

                        const allSlots = activeModulesToday.flatMap(m => m.schedule[dayKey].map(s => ({ ...s, type: m.type })));
                        const morning = allSlots.filter(s => s.start < '12:00').sort((a, b) => a.start.localeCompare(b.start));
                        const afternoon = allSlots.filter(s => s.start >= '12:00' && s.start < '18:00').sort((a, b) => a.start.localeCompare(b.start));
                        const evening = allSlots.filter(s => s.start >= '18:00').sort((a, b) => a.start.localeCompare(b.start));
                        const types = new Set(allSlots.map(s => s.type));

                        // NEW: Calculate worked minutes for the day based on original schedule and add to total
                        if (morning.length) totalMinutesWorked += calculateDurationInMinutes(morning[0].start, morning[morning.length - 1].end);
                        if (afternoon.length) totalMinutesWorked += calculateDurationInMinutes(afternoon[0].start, afternoon[afternoon.length - 1].end);
                        if (evening.length) totalMinutesWorked += calculateDurationInMinutes(evening[0].start, evening[evening.length - 1].end);

                        // NEW: Apply randomization for display purposes
                        const cellsData = [
                            morning.length ? randomizeTime(morning[0].start) : '',
                            morning.length ? randomizeTime(morning[morning.length - 1].end) : '',
                            afternoon.length ? randomizeTime(afternoon[0].start) : '',
                            afternoon.length ? randomizeTime(afternoon[afternoon.length - 1].end) : '',
                            evening.length ? randomizeTime(evening[0].start) : '',
                            evening.length ? randomizeTime(evening[evening.length - 1].end) : '',
                            types.has('presencial') ? 'X' : '',
                            types.has('online') ? 'X' : '',
                            types.has('ead') ? 'X' : '',
                            '', // ATESTADO
                            '', // ASSINATURA
                        ];
                        const timeCells = cellsData.map(content => `<td class="border border-gray-400 p-1 text-center text-xs">${content}</td>`).join('');

                        tableContent += `<tr>${dayCell}${timeCells}</tr>`;
                    }
                }
                $DOMElements.timesheetBody.html(tableContent);

                // NEW: Calculate and display total hours worked
                const totalHours = Math.floor(totalMinutesWorked / 60);
                const totalMinutes = totalMinutesWorked % 60;
                const formattedTotal = `${String(totalHours).padStart(2, '0')}:${String(totalMinutes).padStart(2, '0')}`;
                $('#displayTotalHours').text(` ${formattedTotal}`);


                $DOMElements.timesheetContainer.slideDown();
                $('html, body').animate({ scrollTop: $DOMElements.timesheetContainer.offset().top }, 'slow');
            };

            // --- EVENT HANDLERS ---
            $DOMElements.moduleForm.on('submit', (e) => {
                e.preventDefault();
                const name = $('#moduleName').val().trim();
                const type = $('#moduleType').val();
                const $selectedDays = $('input[name="module-days"]:checked');
                const periodType = $('input[name="modulePeriodType"]:checked').val();

                if (!name || $selectedDays.length === 0) {
                    showToast('Preencha o nome e selecione pelo menos um dia.', true);
                    return;
                }

                let moduleStartDate = null, moduleEndDate = null;
                if (periodType === 'partial') {
                    moduleStartDate = $('#moduleStartDate').val();
                    moduleEndDate = $('#moduleEndDate').val();
                    if (!moduleStartDate || !moduleEndDate || moduleEndDate < moduleStartDate) {
                        showToast("Selecione um período de datas válido para o módulo.", true);
                        return;
                    }
                }

                const schedule = {};
                let hasValidTime = false;
                $selectedDays.each(function () {
                    const day = $(this).val();
                    schedule[day] = $(`#timeSlots-${day} .flex`).map(function () {
                        const $selects = $(this).find('select.time-select');
                        return { start: $selects.eq(0).val(), end: $selects.eq(1).val() };
                    }).get().filter(s => s.start && s.end);

                    if (schedule[day].length > 0) hasValidTime = true;
                });

                if (!hasValidTime) {
                    showToast('Adicione pelo menos um horário válido.', true);
                    return;
                }

                modules.push({ id: currentModuleId++, name, type, schedule, periodType, startDate: moduleStartDate, endDate: moduleEndDate });
                updateModulesList();
                updateScheduleGrid();
                clearModuleForm();
                showToast('Módulo adicionado com sucesso!');
            });

            $DOMElements.absenceForm.on('submit', function (e) {
                e.preventDefault();
                const type = $('input[name="absenceType"]:checked').val();
                const name = $('#absenceName').val();
                const startDate = $('#absenceStartDate').val();
                const endDate = $('#absenceEndDate').val();
                const startTime = $('#absenceStartTime').val();
                const endTime = $('#absenceEndTime').val();

                if (type === 'feriado' && !name.trim()) {
                    showToast('Por favor, preencha o nome do feriado.', true);
                    return;
                }
                if (!startDate || !endDate || endDate < startDate) {
                    showToast('Selecione um período de datas válido para a ausência.', true);
                    return;
                }
                absences.push({ id: currentAbsenceId++, type, name, startDate, endDate, startTime, endTime, isManual: true });
                updateAbsencesList();
                this.reset();
                $('input[name="absenceType"][value="feriado"]').prop('checked', true).trigger('change');
                showToast('Ausência adicionada com sucesso!');
            });

            $DOMElements.daysOfWeekContainer.on('change', 'input[name="module-days"]', function () {
                const $checkbox = $(this);
                const day = $checkbox.val();
                const $scheduleContainer = $(`#schedule-${day}`);
                $scheduleContainer[$checkbox.is(':checked') ? 'slideDown' : 'slideUp']();
                if ($checkbox.is(':checked') && $(`#timeSlots-${day}`).is(':empty')) {
                    addTimeSlotToContainer($(`#timeSlots-${day}`));
                }
            });

            $DOMElements.daySchedules.on('click', '[data-action="removeTimeSlot"]', function () {
                $(this).closest('.flex').remove();
            });

            $DOMElements.daySchedules.on('click', '[data-action="addTimeSlot"]', function () {
                addTimeSlotToContainer($(`#timeSlots-${$(this).data('day')}`));
            });

            $('body').on('click', '[data-action]', function () {
                const $button = $(this);
                const action = $button.data('action');
                const idToRemove = $button.data('id');

                if (action === 'removeModule') {
                    modules = modules.filter(m => m.id !== idToRemove);
                    updateModulesList();
                    updateScheduleGrid();
                    showToast('Módulo removido.');
                } else if (action === 'removeAbsence') {
                    absences = absences.filter(a => a.id !== idToRemove);
                    updateAbsencesList();
                    showToast('Ausência removida.');
                }
            });

            $DOMElements.daySchedules.on('change', '[data-role="start-time"]', function () {
                updateEndTimeOptions($(this));
            });

            $('#absenceStartTime').on('change', function () {
                updateEndTimeOptions($(this));
            });

            $('input[name="modulePeriodType"]').on('change', function () {
                $DOMElements.modulePartialPeriodContainer.slideToggle($(this).val() === 'partial');
            });

            const absenceColorMap = {
                falta: { bg: 'bg-red-600', hover: 'hover:bg-red-700' },
                atestado: { bg: 'bg-yellow-500', hover: 'hover:bg-yellow-600' },
                feriado: { bg: 'bg-blue-600', hover: 'hover:bg-blue-700' }
            };
            const absenceColorClasses = Object.values(absenceColorMap).flatMap(c => [c.bg, c.hover]).join(' ');

            $('input[name="absenceType"]').on('change', function () {
                const type = $(this).val();
                const colors = absenceColorMap[type];
                const $button = $('#absenceForm button[type="submit"]');

                $button.removeClass(absenceColorClasses).addClass(`${colors.bg} ${colors.hover}`);

                if (type === 'feriado') {
                    $DOMElements.absenceNameContainer.slideDown();
                } else {
                    $DOMElements.absenceNameContainer.slideUp();
                }
            });


            $DOMElements.monthYear.on('change', function () {
                updateDateRangeConstraints();
                fetchAndAddHolidays();
            });

            $('#generateBtn').on('click', generateTimesheet);

            $('#printBtn').on('click', () => {
                $DOMElements.toast.removeClass('show');
                window.print();
            });

            // Save and Load logic
            $('#saveBtn').on('click', function () {
                const dataToSave = {
                    professorName: $('#professorName').val(),
                    schoolName: $('#schoolName').val(),
                    monthYear: $('#monthYear').val(),
                    chapa: $('#chapa').val(),
                    contractType: $('#contractType').val(),
                    admissionDate: $('#admissionDate').val(),
                    function: $('#function').val(),
                    modules: modules,
                    absences: absences.filter(a => a.isManual), // Only save manual absences
                    currentModuleId: currentModuleId,
                    currentAbsenceId: currentAbsenceId
                };

                const dataStr = JSON.stringify(dataToSave, null, 2);
                const dataBlob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = `dados_folha_ponto_${new Date().toISOString().slice(0, 10)}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showToast('Dados salvos com sucesso!');
            });

            $('#loadBtn').on('click', function () {
                $('#loadFile').click();
            });

            $('#loadFile').on('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Load data into fields and state
                        $('#professorName').val(data.professorName || '');
                        $('#schoolName').val(data.schoolName || 'ESCOLA DO FUTURO JOSÉ LUIZ BITTENCOURT');
                        $('#monthYear').val(data.monthYear || new Date().toISOString().slice(0, 7));
                        $('#chapa').val(data.chapa || '009268');
                        $('#contractType').val(data.contractType || 'CLT');
                        $('#admissionDate').val(data.admissionDate || '2025-08-25');
                        $('#function').val(data.function || 'Professor para Educação Profissional e Tecnológica X');

                        modules = data.modules || [];
                        absences = data.absences || [];
                        currentModuleId = data.currentModuleId || (modules.length ? Math.max(...modules.map(m => m.id)) + 1 : 0);
                        currentAbsenceId = data.currentAbsenceId || (absences.length ? Math.max(...absences.map(a => a.id)) + 1 : 0);

                        // Update UI
                        updateModulesList();
                        updateAbsencesList();
                        updateScheduleGrid();
                        updateDateRangeConstraints();
                        fetchAndAddHolidays(); // Fetch holidays for the loaded month

                        showToast('Dados carregados com sucesso!');

                    } catch (err) {
                        showToast('Erro ao carregar o arquivo. Verifique se é um JSON válido.', true);
                    }
                };
                reader.readAsText(file);
                $(this).val(''); // Reset file input
            });


            // --- START THE APP ---
            initializeApp();
        });
    </script>
</body>

</html>

