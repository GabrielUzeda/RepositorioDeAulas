<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Trivia Blaster V7 - Ranking System</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px;
            border-left: 2px solid #333;
            border-right: 2px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at bottom, #1a1a2e 0%, #000000 100%);
        }

        /* --- UI LAYER (Perguntas) --- */
        #ui-layer {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            pointer-events: none; 
            z-index: 5;
        }

        .question-box {
            background: rgba(10, 15, 20, 0.95);
            border: 2px solid #00d4ff; 
            border-radius: 6px;
            padding: 0; 
            pointer-events: auto;
            opacity: 0;
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        }

        .question-box.active { opacity: 1; transform: translateY(0); }

        /* AVISOS DE ERRO */
        #error-banner {
            background: #ffaa00;
            color: black;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.9rem;
            padding: 8px;
            display: none; 
            animation: blinkWarning 0.3s infinite;
        }
        #error-banner.critical {
            background: #ff0000;
            color: white;
            animation: blinkCritical 0.1s infinite;
        }

        @keyframes blinkWarning { 50% { background: #ffe600; } }
        @keyframes blinkCritical { 50% { background: #880000; } }

        .q-content { padding: 20px; }

        h2 { 
            margin: 0 0 15px 0; 
            font-size: 1.1rem; 
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 0 #000;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            text-align: left;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 8px;
        }

        /* BOTÕES DE RESPOSTA */
        button.opt-btn {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 12px;
            color: #00d4ff;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-out;
            font-family: 'Courier New', monospace;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }

        button.opt-btn:hover { 
            background: #2a2a2a; 
            border-color: #fff; 
            transform: scale(1.02); 
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            letter-spacing: 1px;
            color: white;
        }
        
        button.opt-btn:active { background: #555; transform: scale(0.98); }
        button.opt-btn.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        /* --- TELAS (START / GAME OVER / VICTORY) --- */
        .overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            display: none;
        }

        #start-screen { display: flex; }
        #start-screen h3 { color: #00d4ff; margin: 0 0 10px 0; letter-spacing: 4px; font-size: 1rem; }
        #phase-title { 
            font-size: 2.5rem; color: #fff; margin: 0 0 40px 0; 
            text-align: center; text-shadow: 0 0 20px #00d4ff; max-width: 80%;
        }

        /* VICTORY SCREEN STYLES */
        #victory-screen h1 { color: #00ff66; font-size: 3rem; text-shadow: 0 0 20px #00ff66; margin-bottom: 10px; text-align: center;}
        #final-score-display { font-size: 2.5rem; color: white; margin-bottom: 20px; font-weight: bold; }
        .score-label { font-size: 1rem; color: #aaa; text-transform: uppercase; letter-spacing: 2px; }

        /* RANKING INPUTS */
        .ranking-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            width: 80%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        input.player-input {
            width: 100%;
            padding: 15px;
            background: #111;
            border: 2px solid #333;
            color: #00ff66;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            text-align: center;
            text-transform: uppercase;
            outline: none;
            transition: 0.3s;
        }
        input.player-input:focus { border-color: #00ff66; box-shadow: 0 0 15px rgba(0, 255, 102, 0.2); }
        input.player-input::placeholder { color: #444; }

        /* BOTÕES PRINCIPAIS */
        .btn-start {
            padding: 15px 40px;
            background: transparent;
            border: 2px solid #00d4ff;
            color: #00d4ff;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            margin-top: 10px;
            width: 100%;
            max-width: 300px;
        }
        .btn-start:hover { background: #00d4ff; color: black; box-shadow: 0 0 30px #00d4ff; transform: scale(1.05); }

        /* VARIAÇÃO VERDE DO BOTÃO */
        .btn-green {
            border-color: #00ff66;
            color: #00ff66;
        }
        .btn-green:hover {
            background: #00ff66;
            color: black; /* Texto preto no fundo verde */
            box-shadow: 0 0 30px #00ff66;
        }
        .btn-green:disabled {
            border-color: #444;
            color: #444;
            background: transparent;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* GAME OVER SCREEN */
        #game-over h1 { font-size: 4rem; color: #ff0000; margin: 0; text-shadow: 0 0 20px red; letter-spacing: -2px;}
        #game-over p { color: #aaa; margin-bottom: 30px; font-size: 1.2rem; }

        /* HUD */
        #score-board {
            position: absolute; top: 20px; left: 20px;
            font-size: 1.4rem; font-weight: bold; color: #fff; z-index: 10;
            text-shadow: 0 0 10px #00d4ff;
        }
        #danger-meter {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #111; z-index: 10;
        }
        #danger-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #00d4ff, #ff0055);
            transition: width 0.1s linear;
        }
        #impact-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; z-index: 4;
            mix-blend-mode: overlay; transition: opacity 0.2s;
        }

        .shake-box { animation: shake 0.4s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-1deg); }
            50% { transform: translateX(5px) rotate(1deg); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* Efeito de +Pontos */
        .float-score {
            position: absolute; color: #ffff00; font-weight: bold; font-size: 1.5rem;
            pointer-events: none; animation: floatUp 1s forwards; z-index: 20; text-shadow: 0 0 5px black;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        /* Mensagem de sucesso do ranking */
        #rank-msg { color: #00ff66; margin-top: 10px; font-weight: bold; height: 20px; }

    </style>
</head>
<body>

    <div id="game-container">
        
        <!-- TELA DE INÍCIO -->
        <div id="start-screen" class="overlay-screen">
            <h3>SIMULAÇÃO TÁTICA</h3>
            <h1 id="phase-title">...</h1>
            <button class="btn-start" onclick="startGame()">INICIAR SISTEMA</button>
        </div>

        <!-- TELA DE GAME OVER -->
        <div id="game-over" class="overlay-screen">
            <h1>DESTRUÍDO</h1>
            <p>Falha Lógica Fatal.</p>
            <button class="btn-start" onclick="resetGame()">Reiniciar</button>
        </div>

        <!-- TELA DE VITÓRIA (Ranking System) -->
        <div id="victory-screen" class="overlay-screen">
            <h1 style="color: #00d4ff; text-shadow: 0 0 20px #00d4ff;">MISSÃO<br>CUMPRIDA</h1>
            <div class="score-label">PONTUAÇÃO FINAL</div>
            <div id="final-score-display">0000</div>
            
            <div class="ranking-form">
                <input type="text" id="player-name" class="player-input" placeholder="SEU NOME" maxlength="12" autocomplete="off">
                <button id="btn-submit" class="btn-start btn-green" onclick="submitScore()">ENVIAR DADOS</button>
                <div id="rank-msg"></div>
            </div>

            <button class="btn-start" onclick="resetGame()">JOGAR NOVAMENTE</button>
        </div>

        <!-- CAMADA DO JOGO -->
        <div id="impact-overlay"></div>
        <div id="danger-meter"><div id="danger-bar"></div></div>
        <div id="score-board">SCORE: <span id="score-val">0</span></div>
        <canvas id="gameCanvas"></canvas>
        
        <!-- CAMADA UI (PERGUNTAS) -->
        <div id="ui-layer">
            <div class="question-box" id="q-box">
                <div id="error-banner">VELOCIDADE CRÍTICA DETECTADA</div>
                <div class="q-content">
                    <h2 id="q-text">Aguardando dados...</h2>
                    <div class="options-grid" id="options-area"></div>
                </div>
            </div>
        </div>

    </div>

<script>
    // --- 1. DADOS DA FASE (ATUALIZADOS) ---
    const gameData = {
        fase: "Módulo: Eng. Software & APIs",
        perguntas: [
            // APIs
            { enunciado: "O que significa API?", alternativas: ["Interface de Programação de Apps", "Aplicação de Internet", "Protocolo de Autenticação", "Algoritmo de Processamento"], gabarito: "Interface de Programação de Apps" },
            { enunciado: "Qual erro indica 'Não Encontrado'?", alternativas: ["Erro 404", "Erro 500", "Erro 200", "Erro 401"], gabarito: "Erro 404" },
            { enunciado: "Em que formato APIs geralmente trocam dados?", alternativas: ["JSON", "HTML Puro", "Docx", "PDF"], gabarito: "JSON" },
            
            // Versionamento (Git)
            { enunciado: "Quem criou o Git?", alternativas: ["Linus Torvalds", "Bill Gates", "Ada Lovelace", "Steve Jobs"], gabarito: "Linus Torvalds" },
            { enunciado: "O que um 'Diff' mostra?", alternativas: ["Apenas as linhas alteradas", "O arquivo inteiro", "O tamanho do arquivo", "Quem deletou o projeto"], gabarito: "Apenas as linhas alteradas" },
            { enunciado: "Um 'Commit' deve ser tratado como:", alternativas: ["Um Checkpoint Lógico", "Um botão Salvar", "Um Backup completo", "Uma pasta ZIP"], gabarito: "Um Checkpoint Lógico" },

            // Histórias de Usuário
            { enunciado: "Qual o foco principal de uma User Story?", alternativas: ["A dor/valor para o usuário", "A complexidade do código", "A linguagem de programação", "A cor do botão"], gabarito: "A dor/valor para o usuário" },
            { enunciado: "O que é uma Persona?", alternativas: ["Representação semi-fictícia do usuário", "Um cliente real específico", "O chefe da empresa", "O desenvolvedor sênior"], gabarito: "Representação semi-fictícia do usuário" },

            // Engenharia de Software
            { enunciado: "O que significa SDLC?", alternativas: ["Software Development Life Cycle", "System Design Logic Code", "Server Data Link Control", "Safe Digital Loop Check"], gabarito: "Software Development Life Cycle" },
            { enunciado: "Qual característica do modelo Waterfall?", alternativas: ["Linear e sequencial", "Cíclico e rápido", "Focado em sprints", "Não documentado"], gabarito: "Linear e sequencial" },
            { enunciado: "Requisito Não-Funcional define:", alternativas: ["Como o sistema se comporta", "O que o sistema faz", "O preço do sistema", "A cor do logotipo"], gabarito: "Como o sistema se comporta" }
        ]
    };

    // --- CONFIGURAÇÃO ---
    document.getElementById('phase-title').innerText = gameData.fase;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let w, h;

    function resize() {
        const container = document.getElementById('game-container');
        w = canvas.width = container.clientWidth;
        h = canvas.height = container.clientHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- VARIÁVEIS DE JOGO ---
    let isPlaying = false;
    let score = 0;
    let gameOver = false;
    let particles = [];
    let stars = [];
    let currentEnemy = null;
    let laser = null;
    let enemyMistakes = 0;
    let controlsLocked = false;
    let availableQuestions = []; 
    let player = { x: w/2, y: h - 100, targetX: w/2, width: 40, height: 50 };

    // Ranking Logic Variables
    let isSubmitting = false;

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        availableQuestions = [...gameData.perguntas].sort(() => Math.random() - 0.5);
        score = 0;
        document.getElementById('score-val').innerText = '0';
        isPlaying = true;
        update();
    }

    // --- SISTEMA DE RANKING (ENDPOINT REAL) ---
    function submitScore() {
        if (isSubmitting) return;

        const nameInput = document.getElementById('player-name');
        const submitBtn = document.getElementById('btn-submit');
        const rankMsg = document.getElementById('rank-msg');
        
        const playerName = nameInput.value.trim();

        if (playerName === "") {
            rankMsg.style.color = "red";
            rankMsg.innerText = "NOME INVÁLIDO";
            nameInput.style.borderColor = "red";
            setTimeout(() => nameInput.style.borderColor = "#333", 500);
            return;
        }

        // --- INÍCIO DO ENVIO ---
        isSubmitting = true;
        nameInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.innerText = "TRANSMITINDO...";
        rankMsg.innerText = "";

        // Envio para o endpoint solicitado
        // Usamos mode: 'no-cors' para evitar erros de bloqueio no navegador (CORS),
        // embora isso signifique que não conseguimos ler a resposta do servidor.
        fetch('http://ptsv3.com/uzeda', {
            method: 'POST',
            body: JSON.stringify({
                player: playerName,
                score: score,
                timestamp: new Date().toISOString()
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            mode: 'no-cors' 
        })
        .then(() => {
            // Sucesso assumido (devido ao no-cors)
            console.log(`[API] Dados enviados para http://ptsv3.com/uzeda`);
            
            submitBtn.innerText = "DADOS ENVIADOS";
            submitBtn.style.borderColor = "#444";
            
            rankMsg.style.color = "#00ff66";
            rankMsg.innerText = "UPLOAD CONCLUÍDO COM SUCESSO";
        })
        .catch((error) => {
            console.error('Erro no envio:', error);
            submitBtn.innerText = "ERRO DE CONEXÃO";
            rankMsg.style.color = "red";
            rankMsg.innerText = "FALHA NA TRANSMISSÃO";
            isSubmitting = false; // Permite tentar de novo
            submitBtn.disabled = false;
        });
    }

    // --- CLASSES ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
            this.color = color;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, Math.random()*2+1, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;
        }
    }

    class Enemy {
        constructor(difficultyMod) {
            this.size = 60;
            this.x = Math.random() * (w - 120) + 60;
            this.y = -70; // Start position
            this.baseSpeed = 0.5 + (difficultyMod * 0.1); 
            this.speed = this.baseSpeed;
            this.color = '#ff0055';
            this.wobble = Math.random() * Math.PI;
        }
        update() {
            this.y += this.speed;
            this.wobble += 0.05;
            this.x += Math.sin(this.wobble) * 0.5;
        }
        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            
            if(this.speed > this.baseSpeed * 2) {
                ctx.shadowBlur = 20; ctx.shadowColor = 'yellow';
            }

            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.moveTo(0, this.size/2); 
            ctx.lineTo(-this.size/2, -this.size/2);
            ctx.lineTo(0, -this.size/4); 
            ctx.lineTo(this.size/2, -this.size/2);
            ctx.fill();

            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI*2); ctx.fill();

            ctx.restore();
            ctx.shadowBlur = 0;
        }
    }

    // --- LÓGICA DE JOGO ---

    function spawnEnemy() {
        if(gameOver) return;
        
        if(availableQuestions.length === 0) {
            triggerVictory();
            return;
        }

        let difficulty = Math.floor(score / 500);
        currentEnemy = new Enemy(difficulty);
        enemyMistakes = 0;
        controlsLocked = false;
        
        const qBox = document.getElementById('q-box');
        const errBanner = document.getElementById('error-banner');
        qBox.className = 'question-box active'; 
        errBanner.style.display = 'none'; 
        errBanner.className = ''; 
        document.getElementById('impact-overlay').style.opacity = '0';
        
        loadNextQuestion();
    }

    function loadNextQuestion() {
        const q = availableQuestions.pop();

        document.getElementById('q-text').innerText = q.enunciado;
        const area = document.getElementById('options-area');
        area.innerHTML = '';

        let opts = [...q.alternativas].sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onpointerdown = (e) => {
                e.preventDefault();
                checkAnswer(opt, q.gabarito, btn);
            };
            area.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct, btnElement) {
        if(controlsLocked) return;

        if(selected === correct) {
            document.getElementById('q-box').classList.remove('active');
            player.targetX = currentEnemy.x; 
            setTimeout(() => shootLaser(), 250);
        } else {
            enemyMistakes++;
            handleMistake(btnElement);
        }
    }

    function handleMistake(btnElement) {
        btnElement.style.background = '#aa0000'; 
        btnElement.style.borderColor = 'red';
        
        const qBox = document.getElementById('q-box');
        const banner = document.getElementById('error-banner');
        
        qBox.classList.remove('shake-box');
        void qBox.offsetWidth; 
        qBox.classList.add('shake-box');

        if (enemyMistakes === 1) {
            currentEnemy.speed *= 4; 
            currentEnemy.color = '#ffff00'; 
            banner.style.display = 'block';
            banner.innerText = "ALERTA: VELOCIDADE CRÍTICA!";
        } else if (enemyMistakes >= 2) {
            controlsLocked = true;
            currentEnemy.speed *= 2; 
            banner.style.display = 'block';
            banner.innerText = "ERRO FATAL! CONTROLES TRAVADOS!";
            banner.classList.add('critical'); 
            document.querySelectorAll('#options-area button').forEach(b => b.classList.add('disabled'));
            document.getElementById('impact-overlay').style.opacity = '0.3';
        }
    }

    function shootLaser() {
        laser = { x: player.x, y: player.y - 20, life: 10 };
        
        setTimeout(() => {
            if(currentEnemy) {
                const startY = -70;
                const endY = player.y - 60; 
                const maxRange = endY - startY;
                const currentDist = currentEnemy.y - startY;
                
                const performance = Math.max(0, 1 - (currentDist / maxRange));
                const pointsEarned = Math.floor(100 + (900 * performance));
                
                score += pointsEarned;
                document.getElementById('score-val').innerText = score;
                showFloatingScore(currentEnemy.x, currentEnemy.y, pointsEarned);
                
                createExplosion(currentEnemy.x, currentEnemy.y, '#ffaa00');
                currentEnemy = null;
            }
        }, 150);
    }
    
    function showFloatingScore(x, y, val) {
        const el = document.createElement('div');
        el.className = 'float-score';
        el.innerText = `+${val}`;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.getElementById('game-container').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    // --- RENDER ---
    function drawStars() {
        if(stars.length < 60) stars.push({x: Math.random()*w, y: 0, s: Math.random()*2});
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        stars.forEach((s, i) => {
            let warp = currentEnemy ? currentEnemy.speed * 2 : 1;
            s.y += s.s + warp; 
            if(s.y > h) stars.splice(i, 1);
            ctx.fillRect(s.x, s.y, s.s, s.s);
        });
    }

    function drawPlayer() {
        // Reduzi de 0.1 para 0.04 para deixar a nave mais lenta/pesada
        player.x += (player.targetX - player.x) * 0.04;
        ctx.save();
        ctx.translate(player.x, player.y);

        if(controlsLocked) {
             ctx.fillStyle = '#444'; 
             if(Math.random()>0.5) particles.push(new Particle(player.x, player.y, '#555'));
        } else {
             ctx.fillStyle = '#e0e0e0';
        }

        ctx.beginPath();
        ctx.moveTo(0, -30); ctx.lineTo(-20, 20); ctx.lineTo(0, 10); ctx.lineTo(20, 20); ctx.fill();

        if(!controlsLocked) {
            ctx.fillStyle = '#00d4ff';
            ctx.shadowBlur = 15; ctx.shadowColor = '#00d4ff';
            ctx.beginPath(); ctx.moveTo(-10, 20); ctx.lineTo(0, 40 + Math.random()*15); ctx.lineTo(10, 20); ctx.fill();
            ctx.shadowBlur = 0;
        }
        ctx.restore();
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<30; i++) particles.push(new Particle(x, y, color));
        const cont = document.getElementById('game-container');
        cont.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
        setTimeout(() => cont.style.transform = 'none', 100);
    }

    function update() {
        if(!isPlaying) return;

        ctx.clearRect(0, 0, w, h);
        drawStars();

        if(!gameOver) {
            if(!currentEnemy) {
                spawnEnemy();
            } else {
                currentEnemy.update();
                currentEnemy.draw(ctx);

                let dangerPct = (currentEnemy.y / (player.y - 50)) * 100;
                document.getElementById('danger-bar').style.width = Math.min(100, dangerPct) + '%';
                
                let dist = Math.hypot(player.x - currentEnemy.x, player.y - currentEnemy.y);
                if(dist < (player.width + currentEnemy.size)/2 || currentEnemy.y > h) {
                    triggerGameOver();
                }
            }

            drawPlayer();

            if(laser) {
                ctx.strokeStyle = '#00d4ff'; ctx.lineWidth = 8; ctx.shadowBlur = 20; ctx.shadowColor='#00d4ff';
                ctx.beginPath(); ctx.moveTo(laser.x, laser.y); ctx.lineTo(laser.x, 0); ctx.stroke();
                laser.life--;
                if(laser.life <= 0) laser = null;
                ctx.shadowBlur=0;
            }
        }

        particles.forEach((p, i) => {
            p.update(); p.draw(ctx);
            if(p.life <= 0) particles.splice(i, 1);
        });

        requestAnimationFrame(update);
    }

    function triggerVictory() {
        isPlaying = false;
        document.getElementById('q-box').classList.remove('active');
        
        // Reset Ranking Form
        isSubmitting = false;
        document.getElementById('player-name').value = '';
        document.getElementById('player-name').disabled = false;
        document.getElementById('btn-submit').disabled = false;
        document.getElementById('btn-submit').innerText = "ENVIAR DADOS";
        document.getElementById('btn-submit').style.borderColor = "#00ff66";
        document.getElementById('rank-msg').innerText = "";

        document.getElementById('victory-screen').style.display = 'flex';
        document.getElementById('final-score-display').innerText = score;
        
        setInterval(() => {
            if(document.getElementById('victory-screen').style.display === 'flex') {
                createExplosion(Math.random()*w, Math.random()*h, '#00ff66');
            }
        }, 500);
    }

    function triggerGameOver() {
        gameOver = true;
        createExplosion(player.x, player.y, '#00d4ff'); 
        document.getElementById('game-over').style.display = 'flex';
        document.getElementById('q-box').classList.remove('active');
        document.getElementById('impact-overlay').style.opacity = '0';
    }

    function resetGame() {
        gameOver = false;
        score = 0;
        document.getElementById('score-val').innerText = '0';
        document.getElementById('game-over').style.display = 'none';
        document.getElementById('victory-screen').style.display = 'none';
        document.getElementById('start-screen').style.display = 'flex';
        currentEnemy = null;
        particles = [];
        isPlaying = false;
        player.x = w/2; player.targetX = w/2;
    }

</script>
</body>
</html>