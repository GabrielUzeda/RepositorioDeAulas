<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repositório de Aulas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
  <style>
    /* Custom Global Styles */
    body {
      font-family: 'Roboto', sans-serif;

    }

    * {
      animation: fade-in 0.6s ease-out forwards;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-hover {
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }

    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .slide-in {
      animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.98);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Modal animations */
    .modal-content.modal-enter {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .modal-content.modal-enter-active {
      opacity: 1;
      transform: scale(1) translateY(0);
    }

    .modal-content.modal-exit {
      opacity: 1;
      transform: scale(1) translateY(0);
      transition: opacity 0.3s ease-in, transform 0.3s ease-in;
    }

    .modal-content.modal-exit-active {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
    }

    /* Quill Editor Styling */
    .ql-toolbar {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      border-bottom: none;
    }

    .ql-container {
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
      border-top: none;
    }

    /* Section fade animations */
    .section-fade-in {
      animation: sectionFadeIn 0.3s ease-in forwards;
    }

    .section-fade-out {
      animation: sectionFadeOut 0.3s ease-out forwards;
    }

    @keyframes sectionFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes sectionFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <header class="bg-blue-600 shadow-lg">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <span class="material-icons text-white text-2xl">school</span>
          <h1 class="text-white text-xl font-medium">Repositório de Aulas</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button id="logoutBtn"
            class="hidden text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200 flex items-center space-x-2">
            <span class="material-icons">logout</span>
            <span>Sair</span>
          </button>
          <button id="backBtn"
            class="hidden text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200 flex items-center space-x-2">
            <span class="material-icons">arrow_back</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <div id="turmasView" class="fade-in hidden">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-light text-gray-800 mb-2" id="turmasTitle">Selecione uma Turma</h2>
        <p class="text-gray-600" id="turmasSubtitle">Escolha a turma para acessar o conteúdo das aulas</p>
      </div>
      <div id="turmasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="alunoTurmasMessage" class="hidden text-center py-8">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 max-w-2xl mx-auto">
          <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="material-icons text-blue-600 text-2xl">school</span>
          </div>
          <h3 class="text-xl font-medium text-blue-900 mb-2">Bem-vindo ao Sistema Acadêmico!</h3>
          <p class="text-blue-700 mb-4">
            Você ainda não foi aceito em nenhuma turma. Solicite entrada nas turmas desejadas para começar a acessar o conteúdo.
          </p>
          <div class="bg-white rounded-lg p-4 border border-blue-200">
            <h4 class="font-medium text-blue-900 mb-2">Turmas Disponíveis para Solicitação:</h4>
            <div id="turmasDisponiveis" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="aulasView" class="hidden">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h2 id="turmaNome" class="text-3xl font-light text-gray-800 mb-2"></h2>
          <p class="text-gray-600">Materiais de aula disponíveis</p>
        </div>
        <div class="flex flex-wrap justify-end space-x-4">
          <button id="showAulasBtn"
            class="px-4 py-2 m-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:text-white   hover:scale-105 transition">
            Aulas
          </button>
          <button id="showAtividadesBtn"
            class="px-4 py-2 m-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:text-white hover:scale-105 transition">
            Atividades
          </button>
        </div>
      </div>

      <!-- Aulas Section -->
      <div id="aulasSection">
        <div id="aulasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>

      <!-- Atividades Section -->
      <div id="atividadesSection" class="hidden">
        <div id="atividadesList" class="space-y-6">
          <!-- Activities will be rendered here -->
        </div>
      </div>
    </div>
  </main>

  <!-- Activity Modal -->
  <div id="activityModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 md:p-2 ">
    <div class="bg-white w-full h-full flex flex-col modal-content rounded-xl">
      <!-- Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10 flex-shrink-0 rounded">
        <div class="flex items-center justify-between">
          <h3 id="activityModalTitle" class="text-xl font-semibold text-gray-900"></h3>
          <button id="closeActivityModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
            <span class="material-icons text-2xl">close</span>
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
        <!-- Left Column -->
        <div class="h-full flex flex-col min-h-[350px] min-w-[280px]">
          <!-- Activity Content -->
          <div id="activityContent" class="rounded-lg flex-1 flex flex-col">

            <div id="activityContentFrame" class="w-full flex-1 min-h-[250px]  bg-white rounded-md overflow-hidden">
              <!-- Content will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="h-full flex flex-col min-h-[350px] min-w-[260px] overflow-y-auto">
          <div class="bg-white p-2 rounded-xl shadow flex-1 flex flex-col mb-2">
            <h3 class="text-lg font-semibold text-gray-800 mb-1">Enviar Atividade</h3>
            <form id="atividadeForm" class="flex-1 flex flex-col space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-0">Seu Nome</label>
                <input type="text" id="alunoNome" name="from_name"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                  required>
              </div>
              <div class="flex-1 flex flex-col">
                <label class="block text-xs font-medium text-gray-600 mb-0">Respostas</label>
                <div id="editor" class="bg-white border border-gray-300 flex-1 min-h-[200px] rounded-md "></div>
                <input type="hidden" id="atividadeTexto" name="mensagem">
              </div>
              <div class="flex justify-end pt-1">
                <button type="submit"
                  class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition">Enviar</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>


  <!-- Password Modal -->
  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 mx-4 w-full max-w-md slide-in modal-content">
      <div class="text-center mb-6">
        <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-blue-600 text-2xl">lock</span>
        </div>
        <h3 class="text-xl font-medium text-gray-800 mb-2">Acesso à Turma</h3>
        <p id="modalTurmaName" class="text-gray-600"></p>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
          <input type="password" id="passwordInput"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="Digite a senha da turma">
        </div>
        <div id="errorMessage" class="hidden text-red-600 text-sm flex items-center space-x-2">
          <span class="material-icons text-sm">error</span>
          <span>Senha incorreta. Tente novamente.</span>
        </div>
        <div class="flex space-x-3 pt-4">
          <button id="cancelBtn"
            class="flex-1 px-6 py-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
          <button id="confirmBtn"
            class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Solicitar Entrada Modal -->
  <div id="solicitarEntradaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 mx-4 w-full max-w-md slide-in modal-content">
      <div class="text-center">
        <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-blue-600 text-2xl">person_add</span>
        </div>
        <h3 class="text-xl font-medium text-gray-800 mb-2">Solicitar Entrada</h3>
        <p id="solicitarModalMessage" class="text-gray-600 mb-6">Deseja solicitar entrada nesta turma?</p>
        <div class="space-y-4">
          <textarea id="mensagemSolicitacao" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" rows="3" placeholder="Mensagem opcional para o professor..."></textarea>
          <div class="flex space-x-3">
            <button id="cancelarSolicitacaoBtn" class="flex-1 px-6 py-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
            <button id="confirmarSolicitacaoBtn" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Solicitar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Componente de Modais de Alerta -->
  <div id="alert-modals-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <script type="module">
    // Importar componente de modais de alerta
    import {
      loadAlertModals,
      showSuccessModal,
      hideSuccessModal,
      showErrorModal,
      hideErrorModal,
      showLoadingModal,
      hideLoadingModal
    } from './componentes/alert-modals.js';

    // Configurações da API
    const API_BASE = 'http://localhost:8080';

    let turmasData = {};
    let turmasDisponiveis = {};
    let currentTurma = null;
    let currentActivityId = null;
    let currentUser = null;
    let currentSolicitacaoTurmaId = null;
    let quill = null;

    const turmasView = document.getElementById('turmasView');
    const aulasView = document.getElementById('aulasView');
    const turmasGrid = document.getElementById('turmasGrid');
    const aulasGrid = document.getElementById('aulasGrid');
    const atividadesList = document.getElementById('atividadesList');
    const logoutBtn = document.getElementById('logoutBtn');
    const backBtn = document.getElementById('backBtn');
    const turmaNome = document.getElementById('turmaNome');

    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const errorMessage = document.getElementById('errorMessage');
    const modalTurmaName = document.getElementById('modalTurmaName');

    const activityModal = document.getElementById('activityModal');
    const closeActivityModalBtn = document.getElementById('closeActivityModal');
    const atividadeForm = document.getElementById('atividadeForm');


    // Funções da API
    async function apiRequest(endpoint, options = {}) {
      const url = `${API_BASE}${endpoint}`;
      const response = await fetch(url, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': currentUser ? currentUser.usuario : '',
          ...options.headers
        },
        ...options
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
        throw new Error(error.message || `HTTP ${response.status}`);
      }

      return response.json();
    }

    async function loadTurmas() {
      try {
        // Primeiro recarregar informações do usuário para ter dados atualizados
        if (currentUser) {
          await reloadCurrentUser();
        }

        const data = await apiRequest('/turmas');
        if (data.success) {
          turmasDisponiveis = {};
          turmasData = {};

          // Carregar todas as turmas disponíveis
          data.turmas.forEach(turma => {
            turmasDisponiveis[turma.id] = {
              id: turma.id,
              nome: turma.nome,
              cor: turma.cor,
              icone: turma.icone,
              aulas: {},
              atividades: []
            };
          });

          // Filtrar turmas baseado no cargo do usuário
          if (currentUser.cargo === 'aluno') {
            // Para alunos: verificar quais turmas eles têm acesso
            const userTurmas = currentUser.turmas || [];
            if (userTurmas.length === 0) {
              // Aluno sem turmas - mostrar interface de solicitação
              showAlunoSemTurmasInterface();
            } else {
              // Aluno com turmas - mostrar apenas as turmas permitidas
              userTurmas.forEach(turmaId => {
                if (turmasDisponiveis[turmaId]) {
                  turmasData[turmaId] = turmasDisponiveis[turmaId];
                }
              });
              renderTurmas();
            }
          } else {
            // Para professores e admins: mostrar todas as turmas
            turmasData = { ...turmasDisponiveis };
            renderTurmas();
          }
        } else {
          throw new Error(data.message || 'Erro ao carregar turmas');
        }
      } catch (error) {
        console.error('Erro ao carregar turmas:', error);
        showErrorModal('Erro ao carregar turmas: ' + error.message);
      }
    }

    async function loadTurmaDetails(turmaId) {
      try {
        // Carregar aulas e atividades da turma
        const [aulasResponse, atividadesResponse] = await Promise.all([
          apiRequest(`/turmas/${turmaId}`),
          apiRequest(`/turmas/${turmaId}/atividades`)
        ]);

        if (aulasResponse.success) {
          turmasData[turmaId].aulas = aulasResponse.turma.aulas || {};
        }

        if (atividadesResponse.success) {
          turmasData[turmaId].atividades = atividadesResponse.atividades || [];
        }
      } catch (error) {
        console.error('Erro ao carregar detalhes da turma:', error);
        // Continua mesmo com erro
      }
    }

    function renderTurmas() {
      turmasGrid.innerHTML = '';
      Object.entries(turmasData).forEach(([id, turma]) => {
        const turmaCard = document.createElement('div');
        turmaCard.className = `${turma.cor} rounded-2xl p-6 text-white cursor-pointer card-hover`;
        turmaCard.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <span class="material-icons text-3xl">${turma.icone}</span>
            <span class="material-icons">arrow_forward</span>
          </div>
          <h3 class="text-xl font-medium mb-2">${turma.nome}</h3>
          <p class="text-white text-opacity-80">Aulas e atividades disponíveis</p>
        `;
        turmaCard.addEventListener('click', () => enterTurma(id, turma));
        turmasGrid.appendChild(turmaCard);
      });
    }

    function showAlunoSemTurmasInterface() {
      // Ocultar elementos padrão
      document.getElementById('turmasTitle').style.display = 'none';
      document.getElementById('turmasSubtitle').style.display = 'none';
      document.getElementById('turmasGrid').style.display = 'none';

      // Mostrar interface de aluno sem turmas
      document.getElementById('alunoTurmasMessage').classList.remove('hidden');
      renderTurmasDisponiveis();
    }

    function renderTurmasDisponiveis() {
      const container = document.getElementById('turmasDisponiveis');
      container.innerHTML = '';

      Object.entries(turmasDisponiveis).forEach(([id, turma]) => {
        const turmaCard = document.createElement('div');
        turmaCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 hover:bg-gray-100 transition cursor-pointer';
        turmaCard.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <span class="material-icons text-gray-600">${turma.icone}</span>
              <div>
                <h4 class="font-medium text-gray-900">${turma.nome}</h4>
                <p class="text-sm text-gray-600">Clique para solicitar entrada</p>
              </div>
            </div>
            <span class="material-icons text-blue-600">person_add</span>
          </div>
        `;
        turmaCard.addEventListener('click', () => showSolicitarEntradaModal(id, turma));
        container.appendChild(turmaCard);
      });
    }

    function showSolicitarEntradaModal(turmaId, turma) {
      currentSolicitacaoTurmaId = turmaId;
      document.getElementById('solicitarModalMessage').textContent = `Deseja solicitar entrada na turma "${turma.nome}"?`;
      document.getElementById('mensagemSolicitacao').value = '';
      document.getElementById('solicitarEntradaModal').classList.remove('hidden');
      document.getElementById('solicitarEntradaModal').classList.add('flex');
    }

    function hideSolicitarEntradaModal() {
      document.getElementById('solicitarEntradaModal').classList.add('hidden');
      document.getElementById('solicitarEntradaModal').classList.remove('flex');
      currentSolicitacaoTurmaId = null;
    }

    async function solicitarEntradaTurma() {
      if (!currentSolicitacaoTurmaId) return;

      const mensagem = document.getElementById('mensagemSolicitacao').value.trim();
      const formData = mensagem ? { mensagem } : {};

      try {
        const response = await apiRequest(`/turmas/${currentSolicitacaoTurmaId}/solicitar-entrada`, {
          method: 'POST',
          body: JSON.stringify(formData)
        });

        if (response.success) {
          hideSolicitarEntradaModal();
          showSuccessModal('Solicitação de entrada enviada com sucesso! Aguarde a aprovação do professor.');
        } else {
          throw new Error(response.message || 'Erro ao solicitar entrada');
        }
      } catch (error) {
        console.error('Erro ao solicitar entrada:', error);
        showErrorModal('Erro ao solicitar entrada: ' + error.message);
      }
    }


    function logout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    }

    function checkAuth() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          showTurmasView();
          return true;
        } catch (error) {
          console.error('Erro ao restaurar sessão:', error);
          localStorage.removeItem('currentUser');
        }
      }
      return false;
    }

    // Recarregar informações do usuário atual
    async function reloadCurrentUser() {
      try {
        // Fazer login novamente para obter dados atualizados
        const loginData = await apiRequest('/auth/login', {
          method: 'POST',
          body: JSON.stringify({
            usuario: currentUser.usuario,
            senha: currentUser.senha || 'asdf1234' // fallback para senha padrão
          })
        });

        if (loginData.success) {
          currentUser = loginData.usuario;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          return true;
        } else {
          console.error('Erro ao recarregar usuário:', loginData.message);
          return false;
        }
      } catch (error) {
        console.error('Erro ao recarregar usuário:', error);
        return false;
      }
    }

    function showTurmasView() {
      // Reset interface elements
      document.getElementById('turmasTitle').style.display = 'block';
      document.getElementById('turmasSubtitle').style.display = 'block';
      document.getElementById('turmasGrid').style.display = 'grid';
      document.getElementById('alunoTurmasMessage').classList.add('hidden');

      loadTurmas();
      turmasView.classList.remove('hidden');
      aulasView.classList.add('hidden');
      backBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
    }

    function hideTurmasView() {
      turmasView.classList.add('hidden');
    }

    async function enterTurma(turmaId, turma) {
      // Verificar se usuário está logado (opcional para testes)
      const savedUser = localStorage.getItem('currentUser');
      if (!savedUser) {
        // Usuário não logado - redirecionar para login
        window.location.href = 'login.html';
        return;
      }

      currentTurma = turmaId;
      showLoadingModal();

      try {
        await loadTurmaDetails(turmaId);
        hideTurmasView();
        showAulasView(turmaId, turma);
      } catch (error) {
        console.error('Erro ao carregar turma:', error);
        showErrorModal('Erro ao carregar dados da turma: ' + error.message);
      } finally {
        hideLoadingModal();
      }
    }

    function renderAulas(aulas) {
      aulasGrid.innerHTML = '';

      // Converter para array e ordenar por ordem
      const aulasArray = Object.values(aulas).sort((a, b) => (a.ordem || 0) - (b.ordem || 0));

      aulasArray.forEach((aula) => {
        const aulaCard = document.createElement('div');
        aulaCard.className = 'bg-white rounded-2xl p-2 shadow-md cursor-pointer card-hover relative';
        aulaCard.innerHTML = `
         <div class="absolute top-0 left-0 transform -translate-x-1/4 -translate-y-1/4">
            <div class="bg-blue-100 p-3 rounded-full max-h-12 flex-shrink-0">
              <b class="text-blue-600">${aula.icone}</b>
            </div>
          </div>
          <div class="flex items-start justify-between p-4">
            <div class="px-4">
              <h3 class="text-lg font-medium text-gray-800">${aula.titulo}</h3>
              <p class="text-gray-600 text-sm">${aula.descricao}</p>
            </div>
            <span class="material-icons text-gray-400">open_in_new</span>
          </div>

        `;
        aulaCard.addEventListener('click', () => { window.open(aula.caminho, '_blank'); });
        aulasGrid.appendChild(aulaCard);
      });
    }

    function renderAtividades(atividades, turmaId) {
      const atividadesContainer = document.getElementById('atividadesList');
      atividadesContainer.innerHTML = '';
      atividadesContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
      if (!atividades || atividades.length === 0) {
        atividadesContainer.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-full">Nenhuma atividade disponível no momento.</p>';
        return;
      }
      atividades.forEach((atividade) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl p-6 shadow-md cursor-pointer card-hover relative';
        card.onclick = () => showActivityModal(atividade);
        const icon = atividade.icone || 'assignment';
        card.innerHTML = `
          <div class="absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/4 ml-2">
            <div class="bg-blue-100 p-3 rounded-full max-h-12 flex-shrink-0">
              <b class=" text-blue-600">${icon}</b>
            </div>
          </div>
          <div class="flex items-start justify-between">
            <div class="flex flex-1">
                <div class="ml-2 flex-1">
                  <h3 class="text-lg font-medium text-gray-800">${atividade.titulo}</h3>
                  <p class="text-gray-600 text-sm">${atividade.descricao}</p>
                </div>
              <span class="material-icons text-gray-400">open_in_new</span>
            </div>
          </div>
        `;
        atividadesContainer.appendChild(card);
      });
    }

    function showAulasView(turmaId, turma) {
      currentTurma = turmaId;
      turmasView.classList.add('hidden');
      aulasView.classList.remove('hidden');
      backBtn.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      turmaNome.textContent = turma.nome;

      renderAulas(turma.aulas || {});

      if (turma.atividades && turma.atividades.length > 0) {
        renderAtividades(turma.atividades, turmaId);
        document.getElementById('showAtividadesBtn').classList.remove('hidden');
      } else {
        atividadesList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma atividade disponível no momento.</p>';
        document.getElementById('showAtividadesBtn').classList.add('hidden');
      }

      document.getElementById('aulasSection').classList.remove('hidden');
      document.getElementById('aulasSection').classList.add('section-fade-in');
      document.getElementById('atividadesSection').classList.add('hidden');
      document.getElementById('showAulasBtn').classList.add('bg-blue-600', 'text-white');
      document.getElementById('showAulasBtn').classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById('showAtividadesBtn').classList.add('bg-gray-200', 'text-gray-700');
      document.getElementById('showAtividadesBtn').classList.remove('bg-blue-600', 'text-white');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goBackToTurmas() {
      aulasView.classList.add('hidden');
      backBtn.classList.add('hidden');
      turmasView.classList.remove('hidden');
      turmasView.classList.add('fade-in');
      logoutBtn.classList.remove('hidden');
      closeActivityModal();
    }

    function initializeQuill() {
      if (quill) return;
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean'], ['code-block']] },
        placeholder: 'Digite sua resposta aqui...',
      });
    }

    function showActivityModal(atividade) {
      // Definir a activity atual e garantir que a turma atual represente a origem da atividade
      currentActivityId = atividade.id;
      if (atividade.turmaId) currentTurma = atividade.turmaId;
      document.getElementById('alunoNome').value = localStorage.getItem('alunoNome') || '';
      document.getElementById('activityModalTitle').textContent = atividade.titulo;
      const frame = document.getElementById('activityContentFrame');
      if (atividade.caminho) {
        frame.innerHTML = `<iframe src="${atividade.caminho + "?nocache=" + Date.now()}" class="w-full h-full border-0 rounded-md"></iframe>`;
      } else {
        frame.innerHTML = `<div class="p-4 text-center text-gray-500 flex items-center justify-center h-full">Nenhum conteúdo de apoio para esta atividade.</div>`;
      }

      initializeQuill();
      const savedDraft = localStorage.getItem(`draft_${atividade.id}`);
      if (savedDraft) { quill.clipboard.dangerouslyPasteHTML(savedDraft); }
      else { quill.setContents([{ insert: '\n' }]); }
      quill.on('text-change', () => {
        const content = quill.root.innerHTML;
        if (content && content !== '<p><br></p>') localStorage.setItem(`draft_${atividade.id}`, content);
      });
      activityModal.classList.remove('hidden');
      activityModal.classList.add('flex');
      const modalContent = activityModal.querySelector('.modal-content');
      modalContent.classList.add('modal-enter');
      setTimeout(() => modalContent.classList.add('modal-enter-active'), 10);
    }

    function closeActivityModal() {
      const modalContent = activityModal.querySelector('.modal-content');
      modalContent.classList.add('modal-exit');
      modalContent.classList.remove('modal-enter-active');
      setTimeout(() => {
        activityModal.classList.add('hidden');
        activityModal.classList.remove('flex');
        modalContent.classList.remove('modal-exit');
        if (quill) { quill.off('text-change'); quill.root.innerHTML = ''; }
        atividadeForm.reset(); currentActivityId = null;
      }, 300);
    }

    function setupEventListeners() {
      // Logout button
      logoutBtn.addEventListener('click', logout);

      // Outros event listeners
      backBtn.addEventListener('click', goBackToTurmas);

      // Solicitar entrada modal
      document.getElementById('cancelarSolicitacaoBtn').addEventListener('click', hideSolicitarEntradaModal);
      document.getElementById('confirmarSolicitacaoBtn').addEventListener('click', solicitarEntradaTurma);
      closeActivityModalBtn.addEventListener('click', closeActivityModal);
      activityModal.addEventListener('click', (e) => { if (e.target === activityModal) closeActivityModal(); });
      document.getElementById('alunoNome').addEventListener('input', (e) => { localStorage.setItem('alunoNome', e.target.value); });
      document.getElementById('showAulasBtn').addEventListener('click', function () {
        const aulasSection = document.getElementById('aulasSection');
        const atividadesSection = document.getElementById('atividadesSection');
        if (!atividadesSection.classList.contains('hidden')) {
          atividadesSection.classList.add('section-fade-out');
          setTimeout(() => {
            atividadesSection.classList.add('hidden');
            atividadesSection.classList.remove('section-fade-out');
            aulasSection.classList.remove('hidden');
            aulasSection.classList.add('section-fade-in');
          }, 300);
        } else {
          aulasSection.classList.remove('hidden');
          aulasSection.classList.add('section-fade-in');
        }
        this.classList.add('bg-blue-600', 'text-white');
        this.classList.remove('bg-gray-200', 'text-gray-700');
        const atividadesBtn = document.getElementById('showAtividadesBtn');
        atividadesBtn.classList.add('bg-gray-200', 'text-gray-700');
        atividadesBtn.classList.remove('bg-blue-600', 'text-white');
      });
      document.getElementById('showAtividadesBtn').addEventListener('click', function () {
        const aulasSection = document.getElementById('aulasSection');
        const atividadesSection = document.getElementById('atividadesSection');
        if (!aulasSection.classList.contains('hidden')) {
          aulasSection.classList.add('section-fade-out');
          setTimeout(() => {
            aulasSection.classList.add('hidden');
            aulasSection.classList.remove('section-fade-out');
            atividadesSection.classList.remove('hidden');
            atividadesSection.classList.add('section-fade-in');
          }, 300);
        } else {
          atividadesSection.classList.remove('hidden');
          atividadesSection.classList.add('section-fade-in');
        }
        this.classList.add('bg-blue-600', 'text-white');
        this.classList.remove('bg-gray-200', 'text-gray-700');
        const aulasBtn = document.getElementById('showAulasBtn');
        aulasBtn.classList.add('bg-gray-200', 'text-gray-700');
        aulasBtn.classList.remove('bg-blue-600', 'text-white');
      });

      atividadeForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        // Determina corretamente a atividade e a turma associada
        let turmaId = null;
        let atividade = null;

        // Primeiro tenta a turma atualmente selecionada
        if (currentTurma && turmasData[currentTurma] && turmasData[currentTurma].atividades) {
          atividade = turmasData[currentTurma].atividades.find(a => a.id === currentActivityId);
          if (atividade) turmaId = currentTurma;
        }

        // Se não encontrou, busca globalmente
        if (!atividade) {
          for (const [tid, turma] of Object.entries(turmasData)) {
            if (turma.atividades) {
              const found = turma.atividades.find(a => a.id === currentActivityId);
              if (found) { atividade = found; turmaId = tid; break; }
            }
          }
        }

        // Se a própria atividade tem turmaId atribuído (renderAtividades), prioriza isso
        if (atividade && atividade.turmaId) turmaId = atividade.turmaId;

        const turma = turmaId ? turmasData[turmaId] : null;
        if (!turma) { showErrorModal('Erro: Turma não encontrada.'); return; }
        if (!atividade) { showErrorModal('Erro: Não foi possível encontrar os dados da atividade.'); return; }

        const alunoNome = document.getElementById('alunoNome').value.trim();
        if (!alunoNome) { showErrorModal('Por favor, preencha seu nome.'); return; }
        if (!quill.getText().trim()) { showErrorModal('Por favor, escreva sua resposta antes de enviar.'); return; }
        const conteudo = quill.root.innerHTML;
        const isSubmitted = true; // Marcar como submetida

        showLoadingModal();
        try {
          // Primeiro, criar uma pergunta se não existir
          // Como estamos usando perguntas padrão criadas automaticamente, vamos usar a primeira
          const perguntasResponse = await apiRequest(`/atividades/${atividade.id}/perguntas`);
          let perguntaId = null;

          if (perguntasResponse.success && perguntasResponse.perguntas.length > 0) {
            perguntaId = perguntasResponse.perguntas[0].id;
          } else {
            // Criar pergunta padrão se não existir
            const perguntaResponse = await apiRequest('/perguntas', {
              method: 'POST',
              body: JSON.stringify({
                atividade_id: atividade.id,
                enunciado: "Questão principal da atividade",
                pontos: 10.0,
                ordem: 1
              })
            });
            if (perguntaResponse.success) {
              perguntaId = perguntaResponse.pergunta_id;
            } else {
              throw new Error('Não foi possível criar pergunta para a atividade');
            }
          }

          // Submeter resposta
          const respostaResponse = await apiRequest('/respostas', {
            method: 'POST',
            body: JSON.stringify({
              pergunta_id: perguntaId,
              atividade_id: atividade.turma_id,
              conteudo: conteudo,
              is_submitted: isSubmitted
            })
          });

          if (respostaResponse.success) {
            localStorage.removeItem(`draft_${atividade.id}`);
            closeActivityModal();
            showSuccessModal('Atividade enviada com sucesso!');
          } else {
            throw new Error(respostaResponse.message || 'Erro ao enviar atividade');
          }
        } catch (error) {
          console.error('Erro ao enviar atividade:', error);
          showErrorModal(`Erro ao enviar atividade: ${error.message || 'Erro desconhecido'}`);
        } finally {
          hideLoadingModal();
        }
      });
    }

    async function main() {
      try {
        // Carregar componente de modais de alerta
        await loadAlertModals();

        // Verificar autenticação e restaurar sessão
        if (!checkAuth()) {
          console.log('Usuário não logado, redirecionando para login...');
          window.location.href = 'login.html';
          return;
        }

        // Usuário logado - mostrar turmas
        console.log('Usuário logado, carregando turmas...');
        setupEventListeners();
      } catch (error) {
        console.error('Erro ao inicializar aplicação:', error);
        // Fallback para erro sem modal (caso o componente não tenha carregado)
        alert('Falha ao inicializar a aplicação. Por favor, recarregue a página.');
      }
    }
    main();
  </script>
</body>

</html>